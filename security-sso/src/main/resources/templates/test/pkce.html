<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth2 PKCE æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #666;
            font-size: 1rem;
        }

        .info-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .info-section h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        .info-item {
            margin-bottom: 1rem;
        }

        .info-item label {
            color: #555;
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 600;
        }

        .info-item input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: #fff;
        }

        .info-item input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .info-item code {
            background: #e9ecef;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .start-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-bottom: 1rem;
        }

        .start-btn:hover {
            transform: translateY(-2px);
        }

        .back-link {
            display: block;
            text-align: center;
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .step-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .step-info h4 {
            color: #1976d2;
            margin-bottom: 0.5rem;
        }

        .step-info ol {
            margin-left: 1.2rem;
        }

        .step-info li {
            margin-bottom: 0.3rem;
            color: #333;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>OAuth2 PKCE æµ‹è¯•</h1>
            <p>æµ‹è¯• OAuth2 æˆæƒç æµç¨‹ + PKCE æ‰©å±•</p>
        </div>

        <div class="step-info">
            <h4>æµ‹è¯•æµç¨‹è¯´æ˜</h4>
            <ol>
                <li>ç‚¹å‡»"å¼€å§‹ PKCE æˆæƒ"æŒ‰é’®</li>
                <li>ç³»ç»Ÿç”Ÿæˆ code_verifier å’Œ code_challenge</li>
                <li>è·³è½¬åˆ° OAuth2 æˆæƒé¡µé¢ (/oauth2/authorize)</li>
                <li>ç”¨æˆ·ç¡®è®¤æˆæƒåè·å–æˆæƒç  (code)</li>
                <li>è·³è½¬åˆ°å›è°ƒé¡µé¢ï¼Œä½¿ç”¨ code å’Œ code_verifier æ¢å– access_token</li>
            </ol>
        </div>

        <div class="info-section">
            <h3>OAuth2 å®¢æˆ·ç«¯ä¿¡æ¯</h3>
            <div class="info-item">
                <label for="clientId">Client ID:</label>
                <input type="text" id="clientId" value="webapp-client" />
            </div>
            <div class="info-item">
                <label for="redirectUri">Redirect URI:</label>
                <input type="text" id="redirectUri" value="http://localhost:9000/test/callback" />
            </div>
            <div class="info-item">
                <label for="scope">Scope:</label>
                <input type="text" id="scope" value="read write openid profile offline_access" />
            </div>
            <div class="info-item">
                <label>Response Type:</label>
                <code>code</code>
            </div>
        </div>

        <div class="info-section">
            <h3>PKCE å‚æ•°</h3>
            <div class="info-item">
                <label>Code Verifier:</label>
                <code id="codeVerifier">æ­£åœ¨ç”Ÿæˆ...</code>
            </div>
            <div class="info-item">
                <label>Code Challenge:</label>
                <code id="codeChallenge">æ­£åœ¨ç”Ÿæˆ...</code>
            </div>
        </div>

        <button id="startPkceBtn" class="start-btn" onclick="startPkceFlow()">
            ğŸš€ å¼€å§‹ PKCE æˆæƒ
        </button>

        <a href="/login" class="back-link">â† è¿”å›ç™»å½•é¡µé¢</a>
    </div>

    <script>
        // ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
        function generateRandomString(length) {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return result;
        }

        // SHA256 å“ˆå¸Œå‡½æ•°
        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return hash;
        }

        // Base64 URL ç¼–ç 
        function base64UrlEncode(arrayBuffer) {
            const bytes = new Uint8Array(arrayBuffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // å…¨å±€å˜é‡å­˜å‚¨PKCEå‚æ•°
        let pkceParams = {
            codeVerifier: null,
            codeChallenge: null
        };

        // ç”ŸæˆPKCEå‚æ•°
        async function generatePkceParams() {
            try {
                // ç”Ÿæˆ code_verifier (43-128 å­—ç¬¦)
                pkceParams.codeVerifier = generateRandomString(128);

                // ç”Ÿæˆ code_challenge
                const hashed = await sha256(pkceParams.codeVerifier);
                pkceParams.codeChallenge = base64UrlEncode(hashed);

                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                document.getElementById('codeVerifier').textContent = pkceParams.codeVerifier;
                document.getElementById('codeChallenge').textContent = pkceParams.codeChallenge;

                console.log('PKCE Parameters Generated:');
                console.log('code_verifier:', pkceParams.codeVerifier);
                console.log('code_challenge:', pkceParams.codeChallenge);

            } catch (error) {
                console.error('PKCE å‚æ•°ç”Ÿæˆå¤±è´¥:', error);
                document.getElementById('codeVerifier').textContent = 'ç”Ÿæˆå¤±è´¥';
                document.getElementById('codeChallenge').textContent = 'ç”Ÿæˆå¤±è´¥';
            }
        }

        // å¼€å§‹ PKCE æµç¨‹
        async function startPkceFlow() {
            try {
                // æ£€æŸ¥PKCEå‚æ•°æ˜¯å¦å·²ç”Ÿæˆ
                if (!pkceParams.codeVerifier || !pkceParams.codeChallenge) {
                    alert('PKCE å‚æ•°æœªç”Ÿæˆï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }

                // ä»ç•Œé¢è¯»å–å‚æ•°
                const clientId = document.getElementById('clientId').value.trim();
                const redirectUri = document.getElementById('redirectUri').value.trim();
                const scope = document.getElementById('scope').value.trim();

                // éªŒè¯å¿…å¡«å‚æ•°
                if (!clientId) {
                    alert('è¯·è¾“å…¥ Client ID');
                    return;
                }
                if (!redirectUri) {
                    alert('è¯·è¾“å…¥ Redirect URI');
                    return;
                }
                if (!scope) {
                    alert('è¯·è¾“å…¥ Scope');
                    return;
                }

                // ç”Ÿæˆ state å‚æ•°
                const state = generateRandomString(32);

                // ä¿å­˜åˆ° sessionStorage
                sessionStorage.setItem('code_verifier', pkceParams.codeVerifier);
                sessionStorage.setItem('state', state);

                console.log('Starting PKCE Flow:');
                console.log('client_id:', clientId);
                console.log('redirect_uri:', redirectUri);
                console.log('scope:', scope);
                console.log('code_verifier:', pkceParams.codeVerifier);
                console.log('code_challenge:', pkceParams.codeChallenge);
                console.log('state:', state);

                // å¤„ç†scopeï¼Œç¡®ä¿ä½¿ç”¨ç©ºæ ¼åˆ†éš”
                const processedScope = scope.replace(/,/g, ' ');
                console.log('æˆæƒè¯·æ±‚Scopeå¤„ç†:');
                console.log(' - åŸå§‹å€¼:', scope);
                console.log(' - æ›¿æ¢é€—å·å:', processedScope);

                // æ„å»ºæˆæƒ URL - ä½¿ç”¨ä¸oauth-pkce.htmlç›¸åŒçš„æ–¹å¼
                const authUrl = `/oauth2/authorize?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(processedScope)}&code_challenge_method=S256&code_challenge=${pkceParams.codeChallenge}&state=${state}&access_type=offline`;

                console.log('Authorization URL:', authUrl);

                // è·³è½¬åˆ°æˆæƒé¡µé¢
                window.location.href = authUrl;

            } catch (error) {
                console.error('PKCE æµç¨‹å¯åŠ¨å¤±è´¥:', error);
                alert('PKCE æµç¨‹å¯åŠ¨å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶ç”ŸæˆPKCEå‚æ•°
        window.addEventListener('DOMContentLoaded', function() {
            generatePkceParams();
        });
    </script>
</body>

</html>