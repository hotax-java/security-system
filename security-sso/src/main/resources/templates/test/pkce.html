<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth2 PKCE 测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #666;
            font-size: 1rem;
        }

        .info-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .info-section h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        .info-item {
            margin-bottom: 1rem;
        }

        .info-item label {
            color: #555;
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 600;
        }

        .info-item input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            background: #fff;
        }

        .info-item input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .info-item code {
            background: #e9ecef;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .start-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-bottom: 1rem;
        }

        .start-btn:hover {
            transform: translateY(-2px);
        }

        .back-link {
            display: block;
            text-align: center;
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .step-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .step-info h4 {
            color: #1976d2;
            margin-bottom: 0.5rem;
        }

        .step-info ol {
            margin-left: 1.2rem;
        }

        .step-info li {
            margin-bottom: 0.3rem;
            color: #333;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>OAuth2 PKCE 测试</h1>
            <p>测试 OAuth2 授权码流程 + PKCE 扩展</p>
        </div>

        <div class="step-info">
            <h4>测试流程说明</h4>
            <ol>
                <li>点击"开始 PKCE 授权"按钮</li>
                <li>系统生成 code_verifier 和 code_challenge</li>
                <li>跳转到 OAuth2 授权页面 (/oauth2/authorize)</li>
                <li>用户确认授权后获取授权码 (code)</li>
                <li>跳转到回调页面，使用 code 和 code_verifier 换取 access_token</li>
            </ol>
        </div>

        <div class="info-section">
            <h3>OAuth2 客户端信息</h3>
            <div class="info-item">
                <label for="clientId">Client ID:</label>
                <input type="text" id="clientId" value="webapp-client" />
            </div>
            <div class="info-item">
                <label for="redirectUri">Redirect URI:</label>
                <input type="text" id="redirectUri" value="http://localhost:9000/test/callback" />
            </div>
            <div class="info-item">
                <label for="scope">Scope:</label>
                <input type="text" id="scope" value="read write openid profile offline_access" />
            </div>
            <div class="info-item">
                <label>Response Type:</label>
                <code>code</code>
            </div>
        </div>

        <div class="info-section">
            <h3>PKCE 参数</h3>
            <div class="info-item">
                <label>Code Verifier:</label>
                <code id="codeVerifier">正在生成...</code>
            </div>
            <div class="info-item">
                <label>Code Challenge:</label>
                <code id="codeChallenge">正在生成...</code>
            </div>
        </div>

        <button id="startPkceBtn" class="start-btn" onclick="startPkceFlow()">
            🚀 开始 PKCE 授权
        </button>

        <a href="/login" class="back-link">← 返回登录页面</a>
    </div>

    <script>
        // 生成随机字符串
        function generateRandomString(length) {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return result;
        }

        // SHA256 哈希函数
        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return hash;
        }

        // Base64 URL 编码
        function base64UrlEncode(arrayBuffer) {
            const bytes = new Uint8Array(arrayBuffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // 全局变量存储PKCE参数
        let pkceParams = {
            codeVerifier: null,
            codeChallenge: null
        };

        // 生成PKCE参数
        async function generatePkceParams() {
            try {
                // 生成 code_verifier (43-128 字符)
                pkceParams.codeVerifier = generateRandomString(128);

                // 生成 code_challenge
                const hashed = await sha256(pkceParams.codeVerifier);
                pkceParams.codeChallenge = base64UrlEncode(hashed);

                // 更新页面显示
                document.getElementById('codeVerifier').textContent = pkceParams.codeVerifier;
                document.getElementById('codeChallenge').textContent = pkceParams.codeChallenge;

                console.log('PKCE Parameters Generated:');
                console.log('code_verifier:', pkceParams.codeVerifier);
                console.log('code_challenge:', pkceParams.codeChallenge);

            } catch (error) {
                console.error('PKCE 参数生成失败:', error);
                document.getElementById('codeVerifier').textContent = '生成失败';
                document.getElementById('codeChallenge').textContent = '生成失败';
            }
        }

        // 开始 PKCE 流程
        async function startPkceFlow() {
            try {
                // 检查PKCE参数是否已生成
                if (!pkceParams.codeVerifier || !pkceParams.codeChallenge) {
                    alert('PKCE 参数未生成，请刷新页面重试');
                    return;
                }

                // 从界面读取参数
                const clientId = document.getElementById('clientId').value.trim();
                const redirectUri = document.getElementById('redirectUri').value.trim();
                const scope = document.getElementById('scope').value.trim();

                // 验证必填参数
                if (!clientId) {
                    alert('请输入 Client ID');
                    return;
                }
                if (!redirectUri) {
                    alert('请输入 Redirect URI');
                    return;
                }
                if (!scope) {
                    alert('请输入 Scope');
                    return;
                }

                // 生成 state 参数
                const state = generateRandomString(32);

                // 保存到 sessionStorage
                sessionStorage.setItem('code_verifier', pkceParams.codeVerifier);
                sessionStorage.setItem('state', state);

                console.log('Starting PKCE Flow:');
                console.log('client_id:', clientId);
                console.log('redirect_uri:', redirectUri);
                console.log('scope:', scope);
                console.log('code_verifier:', pkceParams.codeVerifier);
                console.log('code_challenge:', pkceParams.codeChallenge);
                console.log('state:', state);

                // 处理scope，确保使用空格分隔
                const processedScope = scope.replace(/,/g, ' ');
                console.log('授权请求Scope处理:');
                console.log(' - 原始值:', scope);
                console.log(' - 替换逗号后:', processedScope);

                // 构建授权 URL - 使用与oauth-pkce.html相同的方式
                const authUrl = `/oauth2/authorize?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(processedScope)}&code_challenge_method=S256&code_challenge=${pkceParams.codeChallenge}&state=${state}&access_type=offline`;

                console.log('Authorization URL:', authUrl);

                // 跳转到授权页面
                window.location.href = authUrl;

            } catch (error) {
                console.error('PKCE 流程启动失败:', error);
                alert('PKCE 流程启动失败: ' + error.message);
            }
        }

        // 页面加载时生成PKCE参数
        window.addEventListener('DOMContentLoaded', function() {
            generatePkceParams();
        });
    </script>
</body>

</html>