<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth2 PKCE 授权流程测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            background-color: #f5f5f5;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 10px;
            overflow: auto;
        }
    </style>
</head>

<body>
<h1>OAuth2 PKCE 授权流程测试</h1>

<div class="container">
    <h2>步骤1: 生成 PKCE 参数</h2>
    <button id="generatePkce">生成 PKCE 参数</button>
    <div id="pkceResult"></div>
</div>

<div class="container">
    <h2>步骤2: 发起授权请求</h2>
    <p>客户端ID: <input id="clientId" type="text" value="webapp-client" /></p>
    <p>重定向URI: <input id="redirectUri" type="text" value="http://localhost:9000/test/pkce/callback" /></p>
    <p><small>注意：请确保使用本地地址http://localhost:9000作为前缀</small></p>
    <p>授权范围: <input id="scope" type="text" value="read,write,openid,profile,offline_access" /></p>
    <button id="authorize">发起授权请求</button>
</div>

<div class="container">
    <h2>步骤3: 处理授权回调</h2>
    <div id="callbackResult">等待授权回调...</div>
</div>

<div class="container">
    <h2>步骤4: 使用授权码换取令牌</h2>
    <button id="exchangeToken" disabled>换取令牌</button>
    <div id="tokenResult"></div>
</div>

<div class="container">
    <h2>步骤5: 刷新令牌</h2>
    <button id="refreshToken" disabled>刷新令牌</button>
    <div id="refreshResult"></div>
</div>

<script>
    // 全局变量存储PKCE参数和授权结果
    const state = {
        codeVerifier: null,
        codeChallenge: null,
        authorizationCode: null,
        accessToken: null,
        refreshToken: null
    };

    // 生成随机字符串
    function generateRandomString(length) {
        const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
        let result = '';
        const values = new Uint8Array(length);
        window.crypto.getRandomValues(values);
        values.forEach(value => result += charset[value % charset.length]);
        return result;
    }

    // 计算SHA-256哈希
    async function sha256(plain) {
        const encoder = new TextEncoder();
        const data = encoder.encode(plain);
        const hash = await window.crypto.subtle.digest('SHA-256', data);
        return hash;
    }

    // Base64URL编码
    function base64UrlEncode(buffer) {
        let base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');
        return base64;
    }

    // 生成PKCE参数
    async function generatePkceParams() {
        // 尝试从sessionStorage恢复codeVerifier，如果没有则生成新的
        state.codeVerifier = sessionStorage.getItem('pkce_code_verifier') || generateRandomString(64);

        // 保存到sessionStorage以便在页面跳转后恢复
        sessionStorage.setItem('pkce_code_verifier', state.codeVerifier);

        const hashBuffer = await sha256(state.codeVerifier);
        state.codeChallenge = base64UrlEncode(hashBuffer);

        // 同样保存codeChallenge
        sessionStorage.setItem('pkce_code_challenge', state.codeChallenge);

        document.getElementById('pkceResult').innerHTML = `
                <pre>Code Verifier: ${state.codeVerifier}\nCode Challenge: ${state.codeChallenge}</pre>
            `;
        return { codeVerifier: state.codeVerifier, codeChallenge: state.codeChallenge };
    }

    // 解析URL参数
    function getUrlParameter(url, name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(url);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // 检查URL或sessionStorage是否包含授权码
    function checkForAuthorizationCode() {
        // 首先检查URL中是否有授权码
        const url = window.location.href;
        const urlCode = getUrlParameter(url, 'code');
        const urlState = getUrlParameter(url, 'state');

        // 然后检查sessionStorage是否有授权码
        const storageCode = sessionStorage.getItem('auth_code');
        const storageState = sessionStorage.getItem('auth_state');

        // 使用URL中的授权码，如果没有则使用sessionStorage中的
        const code = urlCode || storageCode;
        const stateParam = urlState || storageState;

        if (code) {
            state.authorizationCode = code;
            document.getElementById('callbackResult').innerHTML = `
                    <pre>授权码: ${code}\nState: ${stateParam}</pre>
                `;
            document.getElementById('exchangeToken').disabled = false;

            // 清除sessionStorage中的授权码，避免重复使用
            if (!urlCode && storageCode) {
                sessionStorage.removeItem('auth_code');
                sessionStorage.removeItem('auth_state');
            }
        }
    }

    // 使用授权码换取令牌
    async function exchangeToken() {
        const clientId = document.getElementById('clientId').value;
        const redirectUri = document.getElementById('redirectUri').value;

        if (!state.authorizationCode || !state.codeVerifier) {
            document.getElementById('tokenResult').innerHTML = '<p style="color: red;">缺少授权码或Code Verifier</p>';
            return;
        }

        // 显示正在请求
        document.getElementById('tokenResult').innerHTML = '<p>正在请求令牌...</p>';

        try {
            // 处理scope，确保使用空格分隔
            const originalScope = document.getElementById('scope').value;
            const scope = originalScope.replace(/,/g, ' ');
            console.log('Scope处理 - 原始值:', originalScope);
            console.log('Scope处理 - 替换逗号后:', scope);

            console.log('交换令牌参数:', {
                grant_type: 'authorization_code',
                client_id: clientId,
                redirect_uri: redirectUri,
                code: state.authorizationCode,
                code_verifier: state.codeVerifier,
                scope: scope
            });

            // 输出重要参数的长度，便于调试
            console.log('授权码长度:', state.authorizationCode.length);
            console.log('Code Verifier长度:', state.codeVerifier.length);
            console.log('完整的Code Verifier:', state.codeVerifier);

            const response = await fetch('/oauth2/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `grant_type=authorization_code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&code=${state.authorizationCode}&code_verifier=${state.codeVerifier}&scope=${encodeURIComponent(scope)}`
            });

            const data = await response.json();

            if (response.ok) {
                state.accessToken = data.access_token;
                state.refreshToken = data.refresh_token;

                document.getElementById('tokenResult').innerHTML = `
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                        <div style="margin-top: 10px; padding: 10px; background-color: #f8f8f8;">
                            <strong>调试信息:</strong><br/>
                            请求的Scope: ${scope}<br/>
                            授权码: ${state.authorizationCode}<br/>
                            Code Verifier长度: ${state.codeVerifier.length}
                        </div>
                    `;

                if (state.refreshToken) {
                    document.getElementById('refreshToken').disabled = false;
                } else {
                    document.getElementById('tokenResult').innerHTML += '<p style="color: orange;">注意：未返回refresh_token</p>';
                }
            } else {
                document.getElementById('tokenResult').innerHTML = `
                        <p style="color: red;">错误: ${data.error}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
            }
        } catch (error) {
            document.getElementById('tokenResult').innerHTML = `
                    <p style="color: red;">错误: ${error.message}</p>
                `;
        }
    }

    // 刷新令牌
    async function refreshAccessToken() {
        const clientId = document.getElementById('clientId').value;

        if (!state.refreshToken) {
            document.getElementById('refreshResult').innerHTML = '<p style="color: red;">缺少刷新令牌</p>';
            return;
        }

        try {
            const response = await fetch('/oauth2/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `grant_type=refresh_token&client_id=${clientId}&refresh_token=${state.refreshToken}`
            });

            const data = await response.json();

            if (response.ok) {
                state.accessToken = data.access_token;
                if (data.refresh_token) {
                    state.refreshToken = data.refresh_token;
                }

                document.getElementById('refreshResult').innerHTML = `
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
            } else {
                document.getElementById('refreshResult').innerHTML = `
                        <p style="color: red;">错误: ${data.error}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
            }
        } catch (error) {
            document.getElementById('refreshResult').innerHTML = `
                    <p style="color: red;">错误: ${error.message}</p>
                `;
        }
    }

    // 事件监听器
    document.getElementById('generatePkce').addEventListener('click', generatePkceParams);

    document.getElementById('authorize').addEventListener('click', () => {
        if (!state.codeChallenge) {
            alert('请先生成PKCE参数！');
            return;
        }

        const clientId = document.getElementById('clientId').value;
        const redirectUri = document.getElementById('redirectUri').value;
        const scope = document.getElementById('scope').value;
        const randomState = generateRandomString(16);

        // 使用标准格式：用空格分隔scope，而不是逗号
        const originalScope = scope; // 保存原始值用于记录
        const processedScope = originalScope.replace(/,/g, ' ');
        console.log('授权请求Scope处理:');
        console.log(' - 原始值:', originalScope);
        console.log(' - 替换逗号后:', processedScope);

        // 添加access_type=offline参数，确保返回刷新令牌
        const authUrl = `/oauth2/authorize?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(processedScope)}&code_challenge_method=S256&code_challenge=${state.codeChallenge}&state=${randomState}&access_type=offline`;

        // 详细记录授权请求参数
        console.log('授权请求URL:', authUrl);
        console.log('授权范围 (原始):', scope);
        console.log('授权范围 (处理后):', processedScope);
        console.log('Code Challenge:', state.codeChallenge);
        console.log('Code Challenge长度:', state.codeChallenge.length);
        window.location.href = authUrl;
    });

    document.getElementById('exchangeToken').addEventListener('click', exchangeToken);
    document.getElementById('refreshToken').addEventListener('click', refreshAccessToken);

    // 页面加载时初始化PKCE参数并检查是否有授权码
    window.onload = function () {
        // 恢复PKCE参数
        state.codeVerifier = sessionStorage.getItem('pkce_code_verifier');
        state.codeChallenge = sessionStorage.getItem('pkce_code_challenge');

        if (state.codeVerifier && state.codeChallenge) {
            document.getElementById('pkceResult').innerHTML = `
                    <pre>Code Verifier: ${state.codeVerifier}\nCode Challenge: ${state.codeChallenge}</pre>
                `;
        }

        // 检查授权码
        checkForAuthorizationCode();
    };
</script>
</body>

</html>